"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[401],{9401:function(t,e,i){i.d(e,{Z:function(){return d}});var s=i(7437),n=i(2265),r=i(5604);class o{onReady(t){this.info=t,this._info_resolver&&(this._info_resolver(t),this._info_resolver=null)}getInfo(){return this.info?Promise.resolve(this.info):new Promise(t=>{this._info_resolver=t})}getAvccBox(){return this.file.moov.traks[0].mdia.minf.stbl.stsd.entries[0].avcC}start(t,e,i){this.stopped||this.stop(),this.stopped=!1,this._onChunk=i,this.file.setExtractionOptions(e.id),this.file.seek((t+1)/1e6,!0),this.file.start()}stop(){this.file.stop(),this.stopped=!0}onSamples(t,e,i){for(let t of i){let e=t.cts/t.timescale,i=new EncodedVideoChunk({type:t.is_sync?"key":"delta",timestamp:1e6*e,duration:t.duration,data:t.data});if(this._onChunk(i),this.stopped)return}}constructor(t){this.file=r.createFile(),this.file.onError=console.error.bind(console),this.file.onReady=this.onReady.bind(this),this.file.onSamples=this.onSamples.bind(this),console.log("fetching file"),fetch(t).then(t=>{console.log("fetch done");let e=t.body.getReader(),i=0,s=this.file;return e.read().then(function t(n){let{done:r,value:o}=n;if(r){s.flush();return}let h=o.buffer;return h.fileStart=i,i+=h.byteLength,s.appendBuffer(h),e.read().then(t)})}),this.info=null,this._info_resolver=null}}class h{getData(){if(this.idx!=this.size)throw"Mismatch between size reserved and sized used";return this.data.slice(0,this.idx)}writeUint8(t){this.data.set([t],this.idx),this.idx++}writeUint16(t){var e=new Uint16Array(1);e[0]=t;var i=new Uint8Array(e.buffer);this.data.set([i[1],i[0]],this.idx),this.idx+=2}writeUint8Array(t){this.data.set(t,this.idx),this.idx+=t.length}constructor(t){this.data=new Uint8Array(t),this.idx=0,this.size=t}}class l{getAvcDescription(t){var e,i=7;for(e=0;e<t.SPS.length;e++)i+=2+t.SPS[e].length;for(e=0;e<t.PPS.length;e++)i+=2+t.PPS[e].length;var s=new h(i);for(s.writeUint8(t.configurationVersion),s.writeUint8(t.AVCProfileIndication),s.writeUint8(t.profile_compatibility),s.writeUint8(t.AVCLevelIndication),s.writeUint8(t.lengthSizeMinusOne+252),s.writeUint8(t.nb_SPS_nalus+224),e=0;e<t.SPS.length;e++)s.writeUint16(t.SPS[e].length),s.writeUint8Array(t.SPS[e].nalu),window.temp=t.SPS[e].nalu;for(s.writeUint8(t.nb_PPS_nalus),e=0;e<t.PPS.length;e++)s.writeUint16(t.PPS[e].length),s.writeUint8Array(t.PPS[e].nalu);return s.getData()}async ready(){let t=await this.source.getInfo();this.videoTrack=t.videoTracks[0],this.audioTrack=t.audioTracks[0]}async getVideoTrackInfo(){return await this.ready(),Promise.resolve({codec:this.videoTrack.codec,displayWidth:this.videoTrack.track_width,displayHeight:this.videoTrack.track_height,extradata:this.getAvcDescription(this.source.getAvccBox())})}demuxVideo(t,e){this.source.start(t,this.videoTrack,e)}stop(){console.log("stopping"),this.source.stop()}constructor(t){this.source=new o(t)}}class a{getFrame(t){if(!(t<0)&&!(t>=this.frames.length))return this.frames[t]}length(){return this.frames.length}async open(){let t=await this.demuxer.getVideoTrackInfo();this.width=t.displayWidth,this.height=t.displayHeight;let e={codec:t.codec,description:t.extradata};if(!VideoDecoder.isConfigSupported(e))throw Error("Codec not supported: ".concat(t.codec));this.decoder.configure(e),this.demuxer.demuxVideo(0,t=>{this.decoder.decode(t)})}close(){this.frames=[]}onVideoFrame(t){this.canvas.width=this.width,this.canvas.height=this.height;let e=this.canvas.getContext("2d",{willReadFrequently:!0});if(null==e)return;e.drawImage(t,0,0,this.width,this.height),t.close();let i=new Image(this.width,this.height);i.src=this.canvas.toDataURL("image/png"),this.frames.push(i),this.props.onVideoFrame()}constructor(t){this.props=t,this.frames=[],this.width=0,this.height=0,this.canvas=document.createElement("canvas"),this.demuxer=new l(t.filename),this.timer=0,this.decoder=new VideoDecoder({output:t=>{this.onVideoFrame(t),null!=this.timer&&clearTimeout(this.timer),this.timer=setTimeout(async()=>{"closed"!=this.decoder.state&&(await this.decoder.flush(),this.decoder.close(),this.props.onVideoLoaded())},500)},error:t=>console.error(t)}),this.open()}}class c{check(){if(this.points.length<2)return!1;for(let t=1;t<this.points.length;t++){let e=this.points[t-1],i=this.points[t];if(i.x===e.x&&i.y===e.y)return this.points.splice(t,1),this.check()}return!0}draw(t,e){if(this.points.length<2){console.error("no points in slider");return}if(t.save(),"none"!==this.color[e]&&this.lineWidth[e]>0){t.strokeStyle=this.color[e],t.lineWidth=this.lineWidth[e];let i=this.points[0];t.beginPath(),t.moveTo(i.x,i.y);for(let e=1;e<this.points.length;e++){let s=this.points[e];t.lineTo(s.x,s.y),i=s}t.stroke()}if(this.debug){for(let e=0;e<this.points.length;e++){let i=this.points[e];if(t.strokeStyle="#ccccff",t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.x+50*i.bx,i.y+50*i.by),t.lineTo(i.x-50*i.bx,i.y-50*i.by),t.stroke(),t.restore(),e<this.points.length-1){t.strokeStyle=i.selected?"#ff2200":"#ffcccc";let s=this.points[e+1];t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.stroke(),t.restore()}}t.strokeStyle="#ff2200",t.strokeRect(this.thumbX-3,this.thumbY-3,6,6)}t.restore()}normPerpendicular(t,e,i,s){let n=t-i,r=e-s,o=Math.hypot(n,r);return{bx:r/o,by:-n/o}}calcBisectors(){this.points.forEach((t,e)=>{if(0===e){let i=this.points[e+1],s=this.normPerpendicular(t.x,t.y,i.x,i.y);t.bx=s.bx,t.by=s.by}else if(e===this.points.length-1){let i=this.points[e-1],s=this.normPerpendicular(i.x,i.y,t.x,t.y);t.bx=s.bx,t.by=s.by}else{let i=this.points[e+1],s=this.points[e-1],n=(Math.PI+Math.atan2(t.y-s.y,t.x-s.x)+Math.atan2(i.y-t.y,i.x-t.x))/2;t.bx=Math.cos(n),t.by=Math.sin(n)}})}side(t,e,i,s,n,r){return r*(t-i)-n*(e-s)}findSection(t,e,i){let s,n,r;console.assert(this.points.length>=2);let o=this.range;for(let h=0;h<this.points.length-1;h++)if((n=this.points[h]).selected=!1,r=this.points[h+1],this.side(t,e,n.x,n.y,n.bx,n.by)*this.side(r.x,r.y,n.x,n.y,n.bx,n.by)>0&&this.side(t,e,r.x,r.y,r.bx,r.by)*this.side(n.x,n.y,r.x,r.y,r.bx,r.by)>0){let l=Math.atan2(r.y-n.y,r.x-n.x),a=Math.atan2(e-n.y,t-n.x),c=Math.abs(Math.hypot(t-n.x,e-n.y)*Math.sin(a-l));(i||c<=this.range)&&(null==s||c<o)&&(o=c,n.selected=!0,s=h)}if(n=this.points[0],r=this.points[1],this.side(t,e,n.x,n.y,n.bx,n.by)*this.side(r.x,r.y,n.x,n.y,n.bx,n.by)<=0){let r=Math.hypot(t-n.x,e-n.y);(i||r<=this.range)&&(null==s||r<o)&&(o=r,s=-1)}if(n=this.points[this.points.length-2],r=this.points[this.points.length-1],this.side(t,e,r.x,r.y,r.bx,r.by)*this.side(n.x,n.y,r.x,r.y,r.bx,r.by)<=0){let n=Math.hypot(t-r.x,e-r.y);(i||n<=this.range)&&(null==s||n<o)&&(o=n,s=this.points.length-1)}return{ind:s,dist:o}}getS(t,e,i,s,n,r,o,h){let l=h*i-o*s;return console.assert(0!=l),Math.abs((h*n-o*r-h*t+o*e)/l)}setThumb(t,e,i){return this.thumbX=t,this.thumbY=e,{tx:t,ty:e,v:i}}getThumb(t,e,i){if(console.assert(this.points.length>=2),i<0){let t=this.points[0];return this.setThumb(t.x,t.y,t.v)}if(i>=this.points.length-1){let t=this.points[i];return this.setThumb(t.x,t.y,t.v)}let s=this.points[i],n=this.points[i+1],r=n.x-s.x,o=n.y-s.y,h=Math.hypot(r,o);console.assert(h>0),r/=h,o/=h;let l=this.getS(t,e,r,o,s.x,s.y,s.bx,s.by),a=this.getS(t,e,r,o,n.x,n.y,n.bx,n.by),c=l+a,u=(s.x*a+n.x*l)/c,d=(s.y*a+n.y*l)/c,f=(s.v*a+n.v*l)/c;return this.setThumb(u,d,f)}constructor(t){this.points=[],this.range=999999,this.color=["red","red","none"],this.lineWidth=[1,1,0],this.active=!0,this.arrow="",this.curLine=-1,this.thumbX=0,this.thumbY=0,this.debug=null!=t&&t}}class u{prepare(){for(let t of this.sliders){if(!t.check())return!1;t.calcBisectors()}return!0}draw(t){for(let e of this.sliders){let i=this.pressed?2:e===this.curSlider?1:0;e.draw(t,i)}}async load(t){let e=await fetch(t);for(let t of(await e.json())){let e=new c(this.props.debug);for(let i of(e.range=t.range,e.arrow=t.arrow,e.lineWidth=t.width,e.color=t.color,t.points)){let t={x:i.x,y:i.y,v:i.v,bx:0,by:0,selected:!1};e.points.push(t)}this.sliders.push(e)}return this.prepare(),!0}onMouseOver(t,e){let i,s;this.sliders.forEach(n=>{let{ind:r,dist:o}=n.findSection(t,e,!1);null!=r&&(null==s||o<s)&&(i=n,s=o)}),this.curSlider=i}onMouseDrag(t,e){if(null==this.curSlider)return;let{ind:i}=this.curSlider.findSection(t,e,!0);if(null==i)return;let{v:s}=this.curSlider.getThumb(t,e,i);this.curValue=s,this.props.onDrag(s)}onMouseDown(t,e){this.pressed=!0,this.onMouseOver(t,e),this.onMouseDrag(t,e)}onMouseUp(){this.curSlider=void 0,this.pressed=!1}constructor(t){this.props=t,this.sliders=[],this.pressed=!1,this.load(t.filename)}}var d=function(t){var e,i;let r=null!==(e=t.width)&&void 0!==e?e:100,o=null!==(i=t.height)&&void 0!==i?i:100,h=(0,n.useRef)(),l=(0,n.useRef)(),c=(0,n.useRef)(null),[d,f]=(0,n.useState)(-1),[p,g]=(0,n.useState)(!0),y=(0,n.useRef)(!1);function v(){if(d<0||null==h.current||null==c.current)return;let t=h.current.getFrame(d);if(null==t){console.log("retry drawing ".concat(d)),setTimeout(v,100);return}let e=c.current.getContext("2d");null==e||(e.drawImage(t,0,0,h.current.width,h.current.height,0,0,r,o),null==l.current||p||l.current.draw(e))}function x(){f(0)}function b(){g(!1)}function w(){y.current=!1,null==l.current||p||(l.current.onMouseUp(),v())}return(0,n.useEffect)(()=>{if(null==h.current&&(h.current=new a({filename:t.filename,onVideoFrame:x,onVideoLoaded:b})),null==l.current){var e;l.current=new u({filename:t.filename.slice(0,-4)+".json",onDrag:t=>{f(Math.round(t))},debug:null!==(e=t.debug)&&void 0!==e&&e})}function i(t){y.current&&t.cancelable&&t.preventDefault()}return window.addEventListener("touchstart",i,{passive:!1}),window.addEventListener("touchmove",i,{passive:!1}),window.addEventListener("touchend",i,{passive:!1}),window.addEventListener("touchcancel",i,{passive:!1}),()=>{null!=h.current&&(h.current.close(),h.current=void 0),null!=l.current&&(l.current=void 0),window.removeEventListener("touchstart",i),window.removeEventListener("touchmove",i),window.removeEventListener("touchend",i),window.removeEventListener("touchcancel",i)}},[t.debug,t.filename]),(0,n.useEffect)(()=>{null!=c.current&&null!=h.current&&v()},[d]),(0,s.jsxs)("div",{style:{...t.style,width:r,height:o,position:"relative"},className:t.className,children:[(0,s.jsx)("canvas",{ref:c,width:r,height:o,className:"bg-blue-200 border border-black-600",style:{width:r,height:o},onMouseMove:function(t){null==l.current||p||(0===t.nativeEvent.buttons?l.current.onMouseOver(t.nativeEvent.offsetX,t.nativeEvent.offsetY):l.current.onMouseDrag(t.nativeEvent.offsetX,t.nativeEvent.offsetY),v())},onMouseDown:function(t){null==l.current||p||(l.current.onMouseDown(t.nativeEvent.offsetX,t.nativeEvent.offsetY),v())},onMouseUp:function(){null==l.current||p||(l.current.onMouseUp(),v())},onTouchStart:function(t){if(y.current=!0,null!=c.current&&null!=l.current&&!p){if(1===t.targetTouches.length){let e=c.current.getBoundingClientRect();l.current.onMouseOver(t.targetTouches[0].clientX-e.left,t.targetTouches[0].clientY-e.top),l.current.onMouseDrag(t.targetTouches[0].clientX-e.left,t.targetTouches[0].clientY-e.top)}v()}},onTouchMove:function(t){if(null!=c.current&&null!=l.current&&!p){if(1===t.targetTouches.length){let e=c.current.getBoundingClientRect();l.current.onMouseDrag(t.targetTouches[0].clientX-e.left,t.targetTouches[0].clientY-e.top)}v()}},onTouchEnd:w,onTouchCancel:function(){w()}}),p&&(0,s.jsx)("div",{style:{position:"absolute",left:0,top:0,background:"rgb(255 255 255 / 0.5)",padding:"4px"},children:"loading ..."})]})}}}]);